---
name: AI Code Review

"on":
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Get changed files
        id: changed
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get diff
        id: diff
        run: |
          diff=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }} # pragma: allowlist secret
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        with:
          script: |
            const Anthropic = require('@anthropic-ai/sdk');
            // Check for API key presence
            if (!process.env.ANTHROPIC_API_KEY) {
              console.log('No API key found, skipping review.');
              return;
            }

            const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

            const diff = process.env.PR_DIFF;
            const changedFiles = process.env.CHANGED_FILES;

            if (diff.length > 100000) {
              console.log('Diff too large for review.');
              return;
            }

            try {
              const response = await client.messages.create({
                model: "claude-3-sonnet-20240229",
                max_tokens: 4096,
                messages: [{
                  role: "user",
                  content: `Review this PR diff and provide feedback:

                  Changed files: ${changedFiles}

                  Diff:
                  ${diff}

                  Provide:
                  1. Summary of changes
                  2. Potential issues or bugs
                  3. Suggestions for improvement
                  4. Security concerns if any

                  Format as GitHub markdown.`
                }]
              });

              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: response.content[0].text,
                event: 'COMMENT'
              });
            } catch (error) {
              console.error('Error during AI review:', error);
              // Don't fail the build
            }
