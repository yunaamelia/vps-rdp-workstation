---
name: CI - Enhanced Test Matrix

"on":
  push:
    branches: [main, develop, 'feature/*']
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'
  ANSIBLE_FORCE_COLOR: '1'
  PY_COLORS: '1'

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ansible-core ansible-lint yamllint pylint
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Run pre-commit hooks (Linting)
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          ignore_paths: 'collections'
          ignore_names: 'get-docker.sh'

  dry-run:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Ansible
        run: |
          pip install ansible-core pipx
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Create Test Inventory
        run: |
          echo "localhost ansible_connection=local" > inventory/test_hosts

      - name: Run Ansible Playbook (Syntax Check)
        env:
          ANSIBLE_COLLECTIONS_PATH: collections
        run: |
          ansible-playbook -i inventory/test_hosts playbooks/main.yml \
            --syntax-check

  # ========================================================================
  # SMOKE TESTS (Fast 2-minute critical path)
  # ========================================================================
  smoke:
    name: Smoke Test (Critical Path)
    runs-on: ubuntu-latest
    needs: dry-run
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Run Smoke Test (Default scenario only)
        run: molecule test --scenario-name default
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/collections
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

  # ========================================================================
  # FULL TEST MATRIX (Parallel execution)
  # ========================================================================
  molecule:
    name: Test (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    needs: smoke
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false

    strategy:
      fail-fast: false
      matrix:
        scenario:
          - default
          - devtools
          - shell
        # TODO: Add new scenarios when implemented:
        # - fonts
        # - kde
        # - editors
        # - tui-tools
        # - monitoring
        # - advanced-dev
        # - network

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.scenario }}-${{ hashFiles('molecule/**/Dockerfile.j2', 'molecule/**/molecule.yml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.scenario }}-
            ${{ runner.os }}-buildx-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Run Molecule Test - ${{ matrix.scenario }}
        run: |
          molecule test --scenario-name ${{ matrix.scenario }}
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/collections
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-logs-${{ matrix.scenario }}
          path: |
            molecule/**/*.log
            /tmp/molecule/**/*.log
          retention-days: 7

  # ========================================================================
  # IDEMPOTENCE VERIFICATION
  # ========================================================================
  idempotence:
    name: Idempotence Check (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    needs: molecule
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      fail-fast: false
      matrix:
        scenario: [default, devtools, shell]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Run Idempotence Test
        run: |
          molecule create --scenario-name ${{ matrix.scenario }}
          molecule converge --scenario-name ${{ matrix.scenario }}
          molecule converge --scenario-name ${{ matrix.scenario }} | tee idempotence.log

          # Check that second run has no changes
          if ! grep -q "changed=0.*failed=0" idempotence.log; then
            echo "❌ Idempotence test failed - playbook is not idempotent"
            cat idempotence.log
            exit 1
          fi

          echo "✅ Idempotence test passed"
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/collections
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

      - name: Cleanup
        if: always()
        run: molecule destroy --scenario-name ${{ matrix.scenario }}

  # ========================================================================
  # TEST SUMMARY
  # ========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, dry-run, smoke, molecule]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax: ${{ needs.dry-run.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke: ${{ needs.smoke.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration: ${{ needs.molecule.result }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.dry-run.result }}" != "success" ]] || \
             [[ "${{ needs.smoke.result }}" != "success" ]] || \
             [[ "${{ needs.molecule.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **One or more tests failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
