---
# Enhanced CI Workflow with Parallel Testing and Smoke Tests
name: CI with Validation

"on":
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  ANSIBLE_FORCE_COLOR: '1'
  PY_COLORS: '1'

jobs:
  # ============================================================================
  #  Phase 1: Fast Quality Gates (Parallel)
  # ============================================================================

  quality-gates:
    name: Code Quality (${{ matrix.tool }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool: [yamllint, ansible-lint, shellcheck]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        if: matrix.tool != 'shellcheck'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        if: matrix.tool == 'ansible-lint'
        run: |
          pip install ansible-core ansible-lint
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Install yamllint
        if: matrix.tool == 'yamllint'
        run: pip install yamllint

      - name: Run yamllint
        if: matrix.tool == 'yamllint'
        run: yamllint .

      - name: Run ansible-lint
        if: matrix.tool == 'ansible-lint'
        run: ansible-lint --force-color

      - name: Run ShellCheck
        if: matrix.tool == 'shellcheck'
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          ignore_paths: 'collections'
          ignore_names: 'get-docker.sh'

  # ============================================================================
  #  Phase 2: Syntax Validation
  # ============================================================================

  syntax-check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Ansible
        run: |
          pip install ansible-core
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Create Test Inventory
        run: |
          echo "localhost ansible_connection=local" > inventory/test_hosts

      - name: Run Syntax Check
        env:
          ANSIBLE_COLLECTIONS_PATH: collections
        run: |
          ansible-playbook -i inventory/test_hosts playbooks/main.yml --syntax-check

  # ============================================================================
  #  Phase 3: Molecule Integration Tests (Parallel)
  # ============================================================================

  molecule:
    name: Molecule (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    needs: syntax-check
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - default
          - devtools
          - shell
          - rollback

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml -p collections

      - name: Run Molecule Test
        run: molecule test -s ${{ matrix.scenario }}
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}/collections
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: molecule-${{ matrix.scenario }}
          path: molecule/${{ matrix.scenario }}/.molecule/
          retention-days: 7

  # ============================================================================
  #  Phase 4: Summary
  # ============================================================================

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quality-gates, syntax-check, molecule]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "Quality Gates: ${{ needs.quality-gates.result }}"
          echo "Syntax Check: ${{ needs.syntax-check.result }}"
          echo "Molecule: ${{ needs.molecule.result }}"

          if [ "${{ needs.quality-gates.result }}" != "success" ] || \
             [ "${{ needs.syntax-check.result }}" != "success" ] || \
             [ "${{ needs.molecule.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi
          echo "✅ All tests passed"
