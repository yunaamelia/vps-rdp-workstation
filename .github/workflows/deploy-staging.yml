---
name: Staging Deployment

"on":
  push:
    branches: [staging]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Check Secrets
        id: check_secrets
        shell: bash
        env:
          SSH_KEY: ${{ secrets.STAGING_SSH_PRIVATE_KEY }} # pragma: allowlist secret
          HOST: ${{ secrets.STAGING_VPS_HOST }}
          USER: ${{ secrets.STAGING_VPS_USERNAME }}
        run: |
          if [[ -n "$SSH_KEY" && -n "$HOST" && -n "$USER" ]]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "Secrets missing (STAGING_SSH_PRIVATE_KEY, STAGING_VPS_HOST, STAGING_VPS_USERNAME). Skipping."
            echo "has_secrets=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        if: steps.check_secrets.outputs.has_secrets == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }} # pragma: allowlist secret

      - name: Configure Inventory
        if: steps.check_secrets.outputs.has_secrets == 'true'
        env:
          STAGING_HOST: ${{ secrets.STAGING_VPS_HOST }}
          STAGING_USER: ${{ secrets.STAGING_VPS_USERNAME }}
        run: |
          # Replace placeholders in staging inventory
          sed -i "s/ansible_host: .* # CHANGE THIS/ansible_host: $STAGING_HOST/" inventory/staging.yml
          sed -i "s/ansible_user: root/ansible_user: $STAGING_USER/" inventory/staging.yml

          # Add host to known_hosts
          mkdir -p ~/.ssh
          ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to Staging
        if: steps.check_secrets.outputs.has_secrets == 'true'
        env:
          VPS_USERNAME: ${{ secrets.STAGING_VPS_USERNAME }}
          VPS_SECRETS_FILE: ./secrets
          VPS_PASSWORD: ${{ secrets.STAGING_VPS_PASSWORD }} # Optional if using key-only but good for sudo
        run: |
          # Create secret file (reusing script, ensures standardized format)
          python3 .github/scripts/create_secret_file.py
          chmod 600 ./secrets

          # Run setup with --staging flag
          ./setup.sh --staging --ci

          # Cleanup
          rm ./secrets
