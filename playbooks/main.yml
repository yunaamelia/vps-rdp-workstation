# VPS RDP Workstation - Main Orchestration Playbook
# Executes all roles in correct dependency order
---
- name: VPS RDP Developer Workstation Setup
  hosts: all
  become: true
  gather_facts: true

  vars:
    installation_start_time: "{{ ansible_date_time.iso8601 }}"

  pre_tasks:
    - name: Display installation banner
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║     VPS RDP Developer Workstation - v3.0.0               ║
          ║     Security-Hardened | Debian 13 | Nordic Theme         ║
          ╚══════════════════════════════════════════════════════════╝
      tags: always

    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - vps_username is defined
          - vps_username | length > 0
          - vps_user_password_hash is defined
          - vps_user_password_hash | length > 0
          - vps_progress_state_file is defined
          - vps_summary_log is defined
        fail_msg: "Required variables (username, password hash, progress file, summary log) must be set"
      no_log: true
      tags: always

    - name: Create state tracking directory
      ansible.builtin.file:
        path: /var/lib/vps-setup
        state: directory
        mode: '0755'
      when: vps_progress_state_file | default('') | dirname == '/var/lib/vps-setup'
      tags: always

    - name: Ensure progress file directory exists (if custom)
      ansible.builtin.file:
        path: "{{ vps_progress_state_file | dirname }}"
        state: directory
        mode: '0755'
      when: vps_progress_state_file is defined
      tags: always

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ vps_backup_dir | default('/var/backups/vps-setup') }}"
        state: directory
        mode: '0750'
      check_mode: false
      tags: always

    - name: Initialize progress tracking
      ansible.builtin.copy:
        dest: "{{ vps_progress_state_file }}"
        content: |
          {
            "version": "3.0.0",
            "started_at": "{{ installation_start_time }}",
            "status": "in_progress",
            "completed_roles": [],
            "current_role": null,
            "failed_roles": []
          }
        mode: '0644'
        force: false
      tags: always

    - name: Clean up conflicting NodeSource keyring (old .gpg file)
      ansible.builtin.file:
        path: /usr/share/keyrings/nodesource.gpg
        state: absent
      tags: always

    - name: Check if NodeSource keyring exists
      ansible.builtin.stat:
        path: /usr/share/keyrings/nodesource.asc
      register: nodesource_key
      tags: always

    - name: Remove NodeSource repo if keyring is missing (prevents apt update failure)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/nodesource.list
        state: absent
      when: not nodesource_key.stat.exists
      tags: always

  roles:
    # =========================================================================
    #  PHASE 1: System Foundation
    # =========================================================================

    - role: common
      tags: [common, foundation]

    # =========================================================================
    #  PHASE 2: Security (BEFORE any services exposed)
    # =========================================================================

    - role: security
      tags: [security]

    # =========================================================================
    #  PHASE 3: Desktop Environment
    # =========================================================================

    - role: desktop
      tags: [desktop, kde]
      when: vps_install_desktop | default(true)

    # =========================================================================
    #  PHASE 3.1: Remote Access (Strictly after Desktop Base)
    # =========================================================================

    - role: xrdp
      tags: [desktop, xrdp]
      when: vps_install_xrdp | default(true)

    - role: kde-optimization
      tags: [desktop, kde, optimization]
      when: vps_install_desktop | default(true)

    # =========================================================================
    #  PHASE 3.2: Desktop Apps & Tools (Strictly after XRDP)
    # =========================================================================

    - role: kde-apps
      tags: [desktop, tools, kde-apps]
      when: vps_install_desktop | default(true)

    # =========================================================================
    #  PHASE 4: Visual Foundation & Terminal
    # =========================================================================

    - role: fonts
      tags: [fonts, visual]

    - role: catppuccin-theme
      tags: [catppuccin, theme, visual]

    - role: terminal
      tags: [terminal, zsh]

    - role: shell-styling
      tags: [shell, visual, fastfetch, starship]

    - role: zsh-enhancements
      tags: [terminal, zsh-plugins]
      when: vps_install_zsh_external_plugins | default(true)

    # =========================================================================
    #  PHASE 5: Development Languages
    # =========================================================================

    - role: development
      tags: [development, languages]

    # =========================================================================
    #  PHASE 6: Containerization
    # =========================================================================

    - role: docker
      tags: [docker, containers]
      when: install_docker | default(true)

    # =========================================================================
    #  PHASE 7: Code Editors (Moved up from Phase 8)
    # =========================================================================

    - role: editors
      tags: [editors, vscode, opencode]

    # =========================================================================
    #  PHASE 8: Development Tools (Renumbered)

    - role: tui-tools
      tags: [tools, tui]
      when: install_tui_tools | default(true)

    - role: network-tools
      tags: [tools, network]
      when: install_network_tools | default(true)

    - role: system-performance
      tags: [tools, performance]
      when: install_performance_tools | default(true)

    - role: text-processing
      tags: [tools, text]
      when: install_text_processing | default(true)

    - role: file-management
      tags: [tools, files]
      when: install_file_management | default(true)

    - role: dev-debugging
      tags: [tools, debugging]
      when: install_dev_debugging | default(true)

    - role: code-quality
      tags: [tools, quality]
      when: install_code_quality | default(true)

    - role: productivity
      tags: [tools, productivity]
      when: install_productivity | default(true)

    - role: log-visualization
      tags: [tools, logging]
      when: install_log_visualization | default(true)

    - role: ai-devtools
      tags: [tools, ai]
      when: install_ai_devtools | default(true)

    # =========================================================================
    #  PHASE 10: Optional Cloud-Native Tools
    # =========================================================================

    - role: cloud-native
      tags: [tools, cloud, kubernetes]
      when: install_cloud_native_tools | default(false)

  post_tasks:
    - name: Update progress tracking - completed
      ansible.builtin.copy:
        dest: "{{ vps_progress_state_file }}"
        content: |
          {
            "version": "3.0.0",
            "started_at": "{{ installation_start_time }}",
            "completed_at": "{{ ansible_date_time.iso8601 }}",
            "status": "completed",
            "completed_roles": ["all"],
            "current_role": null,
            "failed_roles": []
          }
        mode: '0644'
      tags: always

    - name: Generate summary log
      ansible.builtin.template:
        src: templates/summary-log.j2
        dest: "{{ vps_summary_log }}"
        mode: '0640'
      failed_when: false
      tags: always

    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          ╔══════════════════════════════════════════════════════════╗
          ║  ✓ Installation Complete!                                ║
          ╠══════════════════════════════════════════════════════════╣
          ║  RDP Server: {{ ansible_default_ipv4.address | default('localhost') }}:3389
          ║  Username:   {{ vps_username }}
          ║  Theme:      {{ vps_theme_variant | default('nordic') | capitalize }}
          ╠══════════════════════════════════════════════════════════╣
          ║  Connect using Windows Remote Desktop (mstsc.exe)        ║
          ╚══════════════════════════════════════════════════════════╝
      tags: always
