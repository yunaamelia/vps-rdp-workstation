# VPS RDP Workstation - Main Orchestration Playbook
# Executes all roles in correct dependency order
---
- name: VPS RDP Developer Workstation Setup
  hosts: all
  become: true
  gather_facts: true
  any_errors_fatal: true  # Abort entire playbook if ANY task fails on ANY host

  vars:
    installation_start_time: "{{ ansible_facts.date_time.iso8601 }}"

  # NOTE: Role order has been refactored in v3.0.0.
  # Using --resume with a progress.json from a previous version will NOT work correctly.
  # Please start fresh if upgrading from an older version.

  pre_tasks:
    - name: Display installation banner
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║     VPS RDP Developer Workstation - v3.0.0               ║
          ║     Security-Hardened | Debian 13 | Nordic Theme         ║
          ╚══════════════════════════════════════════════════════════╝
      tags: always

    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - vps_username is defined
          - vps_username | length > 0
          - vps_user_password_hash is defined
          - vps_user_password_hash | length > 0
          - vps_progress_state_file is defined
          - vps_summary_log is defined
        fail_msg: "Required variables (username, password hash, progress file, summary log) must be set"
      no_log: true
      tags: always

    - name: Create state tracking directory
      ansible.builtin.file:
        path: /var/lib/vps-setup
        state: directory
        mode: '0755'
      when: vps_progress_state_file | default('') | dirname == '/var/lib/vps-setup'
      tags: always

    - name: Ensure progress file directory exists (if custom)
      ansible.builtin.file:
        path: "{{ vps_progress_state_file | dirname }}"
        state: directory
        mode: '0755'
      when: vps_progress_state_file is defined
      tags: always

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ vps_backup_dir | default('/var/backups/vps-setup') }}"
        state: directory
        mode: '0750'
      check_mode: false
      tags: always

    - name: Initialize progress tracking
      ansible.builtin.copy:
        dest: "{{ vps_progress_state_file }}"
        content: |
          {
            "version": "3.0.0",
            "started_at": "{{ installation_start_time }}",
            "status": "in_progress",
            "completed_roles": [],
            "current_role": null,
            "failed_roles": []
          }
        mode: '0644'
        force: false
      tags: always

    - name: Clean up conflicting NodeSource keyring (old .gpg file)
      ansible.builtin.file:
        path: /usr/share/keyrings/nodesource.gpg
        state: absent
      tags: always

    - name: Check if NodeSource keyring exists
      ansible.builtin.stat:
        path: /usr/share/keyrings/nodesource.asc
      register: nodesource_key
      tags: always

    - name: Remove NodeSource repo if keyring is missing (prevents apt update failure)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/nodesource.list
        state: absent
      when: not nodesource_key.stat.exists
      tags: always

  roles:
    # =========================================================================
    #  PHASE 1: Bootstrap
    # =========================================================================

    - role: common
      tags: [bootstrap, common]

    # =========================================================================
    #  PHASE 2: Security
    # =========================================================================

    - role: security
      tags: [security, hardening]

    # =========================================================================
    #  PHASE 3: Base System
    # =========================================================================

    - role: fonts
      tags: [base, fonts]

    # =========================================================================
    #  PHASE 4: Desktop Environment
    # =========================================================================

    - role: desktop
      tags: [desktop, kde]
      when: vps_install_desktop | default(true)

    - role: xrdp
      tags: [desktop, xrdp]
      when: vps_install_xrdp | default(true)

    - role: kde-optimization
      tags: [desktop, kde, optimization]
      when: vps_install_desktop | default(true)

    - role: kde-apps
      tags: [desktop, kde, apps]
      when: vps_install_desktop | default(true)

    - role: whitesur-theme
      tags: [desktop, theme, whitesur]
      when: vps_whitesur_install | default(true)

    # =========================================================================
    #  PHASE 5: User Configuration
    # =========================================================================

    - role: terminal
      tags: [userconfig, terminal]
      vars:
        vps_terminal_configure_zshrc: false # Let shell-styling handle .zshrc

    - role: tmux
      tags: [terminal, tmux, config]

    - role: shell-styling
      tags: [userconfig, shell, styling]

    - role: zsh-enhancements
      tags: [userconfig, zsh, plugins]
      when: vps_install_zsh_external_plugins | default(true)

    # =========================================================================
    #  PHASE 6: Development Tools
    # =========================================================================

    - role: development
      tags: [devtools, languages]

    - role: docker
      tags: [devtools, docker]
      when: vps_docker_install | default(true)

    - role: editors
      tags: [devtools, editors]

    # =========================================================================
    #  PHASE 7: CLI Tool Roles
    # =========================================================================

    - role: tui-tools
      tags: [tools, tui]
      when: vps_tui_tools_install | default(true)

    - role: network-tools
      tags: [tools, network]
      when: vps_network_tools_install | default(true)

    - role: system-performance
      tags: [tools, performance]
      when: vps_system_performance_install | default(true)

    - role: text-processing
      tags: [tools, text]
      when: vps_text_processing_install | default(true)

    - role: file-management
      tags: [tools, files]
      when: vps_file_management_install | default(true)

    - role: dev-debugging
      tags: [tools, debugging]
      when: vps_dev_debugging_install | default(true)

    - role: code-quality
      tags: [tools, quality]
      when: vps_code_quality_install | default(true)

    - role: productivity
      tags: [tools, productivity]
      when: vps_productivity_install | default(true)

    - role: log-visualization
      tags: [tools, logging]
      when: vps_log_visualization_install | default(true)

    - role: ai-devtools
      tags: [tools, ai]
      when: vps_ai_devtools_install | default(true)

    - role: cloud-native
      tags: [tools, cloud]
      when: vps_cloud_native_tools_install | default(false)

  post_tasks:
    - name: Refresh facts for completion timestamp
      ansible.builtin.setup:
        gather_subset:
          - date_time
      tags: always

    - name: Update progress tracking - completed
      ansible.builtin.copy:
        dest: "{{ vps_progress_state_file }}"
        content: |
          {
            "version": "3.0.0",
            "started_at": "{{ installation_start_time }}",
            "completed_at": "{{ ansible_facts.date_time.iso8601 }}",
            "status": "completed",
            "completed_roles": ["all"],
            "current_role": null,
            "failed_roles": []
          }
        mode: '0644'
      tags: always

    - name: Generate summary log
      ansible.builtin.template:
        src: templates/summary-log.j2
        dest: "{{ vps_summary_log }}"
        mode: '0640'
      failed_when: false
      tags: always

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════╗
          ║  ✓ Installation Complete!                                ║
          ╠══════════════════════════════════════════════════════════╣
          ║  RDP Server: {{ ansible_facts.default_ipv4.address | default('localhost') }}:3389
          ║  Username:   {{ vps_username }}
          ║  Theme:      {{ vps_theme_variant | default('nordic') | capitalize }}
          ╠══════════════════════════════════════════════════════════╣
          ║  Connect using Windows Remote Desktop (mstsc.exe)        ║
          ╚══════════════════════════════════════════════════════════╝
      tags: always
