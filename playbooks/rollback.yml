# =============================================================================
# VPS RDP Workstation - Rollback Playbook
# Safely restores system to pre-installation state
# CRITICAL: Requires user confirmation to prevent accidental rollback
# Version: 3.0.0
# =============================================================================
---
- name: Rollback VPS Setup
  hosts: localhost
  become: true

  vars:
    backup_dir: /var/backups/vps-setup

  vars_prompt:
    - name: confirm_rollback
      prompt: |

        âš ï¸  WARNING: This will rollback the VPS RDP Workstation setup!

        This action will:
          - Restore SSH configuration to backup
          - Restore firewall rules to backup
          - Stop XRDP service
          - Remove installed packages (optional)

        Type 'yes' to confirm rollback
      private: false

  pre_tasks:
    - name: Verify user confirmation
      ansible.builtin.fail:
        msg: "Rollback cancelled by user. Confirmation was: '{{ confirm_rollback }}'"
      when: confirm_rollback | string | lower not in ['yes', 'true']

    - name: Display rollback warning
      ansible.builtin.debug:
        msg: |
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ”„ Starting VPS RDP Workstation Rollback
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  tasks:
    # =========================================================================
    # PHASE 1: Find Latest Backup
    # =========================================================================

    - name: Check backup directory exists
      ansible.builtin.stat:
        path: "{{ backup_dir }}"
      register: backup_check

    - name: Fail if no backups found
      ansible.builtin.fail:
        msg: "No backup directory found at {{ backup_dir }}. Cannot rollback."
      when: not backup_check.stat.exists

    - name: Find backup files
      ansible.builtin.find:
        paths: "{{ backup_dir }}"
        patterns: "*.backup"
      register: backup_files

    # =========================================================================
    # PHASE 2: Stop Services
    # =========================================================================

    - name: Stop XRDP service
      ansible.builtin.systemd:
        name: xrdp
        state: stopped
      ignore_errors: true

    - name: Stop fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: stopped
      ignore_errors: true

    # =========================================================================
    # PHASE 3: Restore Configurations
    # =========================================================================

    - name: Restore SSH configuration
      ansible.builtin.copy:
        src: "{{ backup_dir }}/sshd_config.backup"
        dest: /etc/ssh/sshd_config
        remote_src: true
        backup: true
      when: backup_files.matched > 0
      ignore_errors: true
      notify: Restart SSH

    - name: Restore UFW rules
      ansible.builtin.copy:
        src: "{{ backup_dir }}/ufw-user.rules.backup"
        dest: /etc/ufw/user.rules
        remote_src: true
        backup: true
      when: backup_files.matched > 0
      ignore_errors: true
      notify: Reload UFW

    # =========================================================================
    # PHASE 4: Reload Services
    # =========================================================================

    - name: Reload SSH service
      ansible.builtin.systemd:
        name: sshd
        state: reloaded
      ignore_errors: true

    - name: Reload UFW
      ansible.builtin.shell: ufw reload
      ignore_errors: true

    # =========================================================================
    # PHASE 5: Cleanup (Optional)
    # =========================================================================

    - name: Remove installation logs (optional)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/log/vps-setup.log
        - /var/log/vps-setup-error.log
        - /var/log/vps-setup-summary.log
      when: remove_logs | default(false)
      ignore_errors: true

    - name: Remove state directory (optional)
      ansible.builtin.file:
        path: /var/lib/vps-setup
        state: absent
      when: remove_state | default(false)
      ignore_errors: true

    # =========================================================================
    # PHASE 6: Summary
    # =========================================================================

    - name: Display rollback summary
      ansible.builtin.debug:
        msg: |

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âœ… Rollback Complete
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          Actions taken:
            âœ“ XRDP service stopped
            âœ“ Fail2ban service stopped
            âœ“ SSH configuration restored
            âœ“ Firewall rules restored

          Note: Installed packages were NOT removed.
          To completely remove packages, run with:
            ansible-playbook playbooks/rollback.yml -e remove_packages=true

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: sshd
        state: restarted
      ignore_errors: true

    - name: Reload UFW
      ansible.builtin.shell: ufw reload
      ignore_errors: true
