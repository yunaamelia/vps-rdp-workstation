# Desktop Role - KDE Plasma + XRDP + Nordic Theme
# Full desktop environment for RDP access
---
- name: Install desktop dependencies (Fish, Git, Python DBus)
  ansible.builtin.apt:
    name:
      - fish
      - git
      - python3-dbus
      - qdbus-qt6
      - libkf6config-bin
      - plasma-workspace
    state: present
  tags: [desktop, dependencies]

- name: Create local config directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/kde-config-files"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, config]

- name: Clone Shalva97 KDE Configuration Files
  ansible.builtin.git:
    repo: https://github.com/shalva97/kde-configuration-files.git
    dest: "/home/{{ vps_username }}/.local/share/kde-config-files"
    version: master
    force: true
  become: true
  become_user: "{{ vps_username }}"
  tags: [desktop, config]

- name: Detect kwriteconfig binary
  ansible.builtin.shell: |
    if command -v kwriteconfig6 >/dev/null; then echo "kwriteconfig6";
    elif command -v kwriteconfig5 >/dev/null; then echo "kwriteconfig5";
    else echo "kwriteconfig"; fi
  register: kwriteconfig_bin
  changed_when: false
  tags: [desktop, config]

- name: Patch setupKDE.fish for correct kwriteconfig version
  ansible.builtin.replace:
    path: "/home/{{ vps_username }}/.local/share/kde-config-files/scripts/setupKDE.fish"
    regexp: 'kwriteconfig5'
    replace: "{{ kwriteconfig_bin.stdout }}"
  tags: [desktop, config]

- name: Ensure qdbus alias exists if needed
  ansible.builtin.shell: |
    if ! command -v qdbus >/dev/null; then
      if command -v qdbus-qt6 >/dev/null; then ln -sf $(which qdbus-qt6) /usr/local/bin/qdbus; fi
    fi
  changed_when: false
  tags: [desktop, config]

- name: Run setupKDE.fish
  ansible.builtin.command:
    cmd: fish setupKDE.fish
    chdir: "/home/{{ vps_username }}/.local/share/kde-config-files/scripts"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, config]

- name: Clone WhiteSur-kde theme
  ansible.builtin.git:
    repo: https://github.com/vinceliuice/WhiteSur-kde.git
    dest: /tmp/WhiteSur
    version: master
    depth: 1
  tags: [desktop, theme]

- name: Install WhiteSur-kde theme
  ansible.builtin.command:
    cmd: ./install.sh -a
    chdir: /tmp/WhiteSur
  become: true
  changed_when: true
  # Installs system-wide to /usr/share
  tags: [desktop, theme]

- name: Install WhiteSur-kde theme
  ansible.builtin.command:
    cmd: ./install.sh -a
    chdir: /tmp/WhiteSur
  become: true
  changed_when: true
  # Installs system-wide to /usr/share
  tags: [desktop, theme]

- name: Apply WhiteSur-Dark LookAndFeel
  ansible.builtin.command:
    cmd: lookandfeeltool -a WhiteSur-Dark
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme]

- name: Remove temporary WhiteSur directory
  ansible.builtin.file:
    path: /tmp/WhiteSur
    state: absent
  tags: [desktop, cleanup]
