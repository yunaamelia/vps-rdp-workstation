# Desktop Role - KDE Plasma + XRDP + Nordic Theme
# Full desktop environment for RDP access
---
- name: Install desktop dependencies (Fish, Git, Python DBus)
  ansible.builtin.apt:
    name:
      - fish
      - git
      - python3-dbus
      - python-is-python3
      - xdg-user-dirs
      - qdbus-qt6
      - libkf6config-bin
      - plasma-workspace
      # Build dependencies for SierraBreezeEnhanced
      - build-essential
      - cmake
      - extra-cmake-modules
      - qt6-base-dev
      - libkdecorations3-dev
      - libkf6config-dev
      - libkf6coreaddons-dev
      - libkf6guiaddons-dev
      - libkf6i18n-dev
      - libkf6widgetsaddons-dev
      - libkf6windowsystem-dev
      - libkf6kcmutils-dev
      - libkf6iconthemes-dev
      - libkf6widgetsaddons6
      - sassc
      - libglib2.0-dev-bin
    state: present
  tags: [desktop, dependencies]

- name: Create local config directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/kde-config-files"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, config]

- name: Clone Shalva97 KDE Configuration Files
  ansible.builtin.git:
    repo: https://github.com/shalva97/kde-configuration-files.git
    dest: "/home/{{ vps_username }}/.local/share/kde-config-files"
    version: master
    force: true
  become: true
  become_user: "{{ vps_username }}"
  tags: [desktop, config]

- name: Detect kwriteconfig binary
  ansible.builtin.shell: |
    if command -v kwriteconfig6 >/dev/null; then echo "kwriteconfig6";
    elif command -v kwriteconfig5 >/dev/null; then echo "kwriteconfig5";
    else echo "kwriteconfig"; fi
  register: kwriteconfig_bin
  changed_when: false
  tags: [desktop, config]

- name: Patch setupKDE.fish for correct kwriteconfig version
  ansible.builtin.replace:
    path: "/home/{{ vps_username }}/.local/share/kde-config-files/scripts/setupKDE.fish"
    regexp: 'kwriteconfig5'
    replace: "{{ kwriteconfig_bin.stdout }}"
  tags: [desktop, config]

- name: Make setup scripts executable
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/kde-config-files/scripts"
    state: directory
    mode: '0755'
    recurse: true
  tags: [desktop, config]

- name: Ensure qdbus alias exists if needed
  ansible.builtin.shell: |
    if ! command -v qdbus >/dev/null; then
      if command -v qdbus-qt6 >/dev/null; then ln -sf $(which qdbus-qt6) /usr/local/bin/qdbus;
      elif command -v qdbus6 >/dev/null; then ln -sf $(which qdbus6) /usr/local/bin/qdbus; fi
    fi
  changed_when: false
  tags: [desktop, config]

- name: Run setupKDE.fish
  ansible.builtin.command:
    cmd: dbus-run-session -- fish setupKDE.fish
    chdir: "/home/{{ vps_username }}/.local/share/kde-config-files/scripts"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, config]

- name: Clone WhiteSur-kde theme
  ansible.builtin.git:
    repo: https://github.com/vinceliuice/WhiteSur-kde.git
    dest: /tmp/WhiteSur
    version: master
    depth: 1
  tags: [desktop, theme]

- name: Install WhiteSur-kde theme
  ansible.builtin.command:
    cmd: ./install.sh -c dark
    chdir: /tmp/WhiteSur
  become: true
  changed_when: true
  # Installs system-wide to /usr/share
  tags: [desktop, theme]

- name: Apply WhiteSur-Dark LookAndFeel
  ansible.builtin.command:
    cmd: lookandfeeltool -a WhiteSur-Dark
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme]

- name: Clone La Capitaine icon theme
  ansible.builtin.git:
    repo: https://github.com/keeferrourke/la-capitaine-icon-theme.git
    dest: "/home/{{ vps_username }}/.local/share/icons/La-Capitaine"
    version: master
    depth: 1
  become: true
  become_user: "{{ vps_username }}"
  tags: [desktop, theme, icons]

- name: Configure La Capitaine icons in KDE
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kdeglobals --group Icons --key Theme La-Capitaine"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme, icons]

- name: Download Capitaine Cursors
  ansible.builtin.get_url:
    url: https://github.com/sainnhe/capitaine-cursors/releases/download/r5/Linux.zip
    dest: /tmp/capitaine-cursors.zip
    mode: '0644'
  tags: [desktop, theme, cursors]

- name: Install Capitaine Cursors (extract)
  ansible.builtin.unarchive:
    src: /tmp/capitaine-cursors.zip
    dest: "/home/{{ vps_username }}/.local/share/icons/"
    remote_src: true
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    creates: "/home/{{ vps_username }}/.local/share/icons/dist"
  tags: [desktop, theme, cursors]

- name: Rename Capitaine Cursors directory
  ansible.builtin.command:
    cmd: mv /home/{{ vps_username }}/.local/share/icons/dist /home/{{ vps_username }}/.local/share/icons/capitaine-cursors
    creates: "/home/{{ vps_username }}/.local/share/icons/capitaine-cursors"
  become: true
  become_user: "{{ vps_username }}"
  tags: [desktop, theme, cursors]

- name: Set Capitaine Cursors as default
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kcminputrc --group Mouse --key cursorTheme capitaine-cursors/dark"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme, cursors]

- name: Remove Catppuccin Cursors (Redundant)
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/icons/{{ item }}"
    state: absent
  loop:
    - Catppuccin-Mocha-Blue-Cursors
    - dist
  tags: [desktop, theme, cursors]

- name: Remove Capitaine Cursors zip
  ansible.builtin.file:
    path: /tmp/capitaine-cursors.zip
    state: absent
  tags: [desktop, cleanup]

- name: Clone SierraBreezeEnhanced
  ansible.builtin.git:
    repo: https://github.com/kupiqu/SierraBreezeEnhanced.git
    dest: /tmp/SierraBreezeEnhanced
    version: master
    depth: 1
  tags: [desktop, theme]

- name: Build and Install SierraBreezeEnhanced
  ansible.builtin.shell: |
    mkdir -p build && cd build
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DKDE_INSTALL_USE_QT_SYS_PATHS=ON
    make
    make install
  args:
    chdir: /tmp/SierraBreezeEnhanced
  become: true
  changed_when: true
  tags: [desktop, theme]

- name: Configure SierraBreezeEnhanced as Window Decoration
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kwinrc --group org.kde.kdecoration2 --key library org.kde.sierrabreezeenhanced"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme]

- name: Configure SierraBreezeEnhanced Theme Name
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kwinrc --group org.kde.kdecoration2 --key theme \"Sierra Breeze Enhanced\""
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, theme]

- name: Remove WhiteSur Window Decorations (Redundant)
  ansible.builtin.file:
    path: "/usr/share/aurorae/themes/{{ item }}"
    state: absent
  loop:
    - WhiteSur
    - WhiteSur-Dark
    - WhiteSur-Light
  tags: [desktop, theme]

- name: Remove SierraBreezeEnhanced build directory
  ansible.builtin.file:
    path: /tmp/SierraBreezeEnhanced
    state: absent
  tags: [desktop, cleanup]

- name: Remove temporary WhiteSur directory
  ansible.builtin.file:
    path: /tmp/WhiteSur
    state: absent
  tags: [desktop, cleanup]

- name: Create KWin scripts directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/kwin/scripts"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, tiling]

- name: Clone Fluid Tile
  ansible.builtin.git:
    repo: https://codeberg.org/Serroda/fluid-tile.git
    dest: /tmp/fluid-tile
    depth: 1
    version: main
  tags: [desktop, tiling]

- name: Install Fluid Tile
  ansible.builtin.copy:
    src: /tmp/fluid-tile/
    dest: "/home/{{ vps_username }}/.local/share/kwin/scripts/fluid-tile/"
    remote_src: true
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  when: vps_install_desktop | default(true)
  tags: [desktop, tiling]

- name: Enable Fluid Tile
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kwinrc --group Plugins --key fluid-tileEnabled true"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, tiling]

- name: Disable Karousel (if present)
  ansible.builtin.command:
    cmd: "{{ kwriteconfig_bin.stdout }} --file /home/{{ vps_username }}/.config/kwinrc --group Plugins --key karouselEnabled false"
  become: true
  become_user: "{{ vps_username }}"
  changed_when: true
  tags: [desktop, tiling]

- name: Remove Karousel directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/kwin/scripts/karousel"
    state: absent
  tags: [desktop, cleanup]

- name: Remove Fluid Tile temp directory
  ansible.builtin.file:
    path: /tmp/fluid-tile
    state: absent
  tags: [desktop, cleanup]

- name: Create Window Title Applet directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.local/share/plasma/plasmoids/org.kde.windowtitle"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, panel]

- name: Clone Window Title Applet
  ansible.builtin.git:
    repo: https://github.com/dhruv8sh/plasma6-window-title-applet.git
    dest: /tmp/window-title
    depth: 1
    version: master
  tags: [desktop, panel]

- name: Install Window Title Applet (Manual Copy)
  ansible.builtin.copy:
    src: /tmp/window-title/
    dest: "/home/{{ vps_username }}/.local/share/plasma/plasmoids/org.kde.windowtitle/"
    remote_src: true
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  when: vps_install_desktop | default(true)
  tags: [desktop, panel]

- name: Remove Window Title temp directory
  ansible.builtin.file:
    path: /tmp/window-title
    state: absent
  tags: [desktop, cleanup]

- name: Remove Karousel tarball
  ansible.builtin.file:
    path: /tmp/karousel.tar.gz
    state: absent
  tags: [desktop, cleanup]

# =============================================================================
#  Power User Tools & Enhancements
# =============================================================================

- name: Install essential KDE tools
  ansible.builtin.apt:
    name:
      - python3-pip
      - pipx
      - python3-venv
      - yakuake
      - qt5-style-kvantum
      - qt6-style-kvantum
      - kompare
      - filelight
      - krdc
      - smb4k
      - sweeper
      - kwalletmanager
      - dolphin-plugins
      - kcalc
      - kdeconnect
      - ffmpegthumbs
      - kdegraphics-thumbnailers
      - svgpart
      - markdownpart
    state: present
  when: vps_install_desktop | default(true)
  tags: [desktop, tools]

- name: Install Awesome KDE recommendations
  ansible.builtin.apt:
    name:
      - krusader
      - okteta
      - ghostwriter
      - ksystemlog
      - kcolorchooser
      - krename
    state: present
  when: vps_install_desktop | default(true)
  tags: [desktop, tools, awesome-kde]

- name: Create Kvantum config directory
  ansible.builtin.file:
    path: '/home/{{ vps_username }}/.config/Kvantum'
    state: directory
    owner: '{{ vps_username }}'
    group: '{{ vps_username }}'
    mode: '0755'
    recurse: true
  tags: [desktop, theme]

- name: Set Kvantum theme to WhiteSurDark
  community.general.ini_file:
    path: '/home/{{ vps_username }}/.config/Kvantum/kvantum.kvconfig'
    section: General
    option: theme
    value: WhiteSurDark
    create: true
    owner: '{{ vps_username }}'
    group: '{{ vps_username }}'
    mode: '0644'
  tags: [desktop, theme]

# =============================================================================
#  Performance & Optimization
# =============================================================================

- name: Disable Baloo file indexing (config)
  community.general.ini_file:
    path: "/home/{{ vps_username }}/.config/baloofilerc"
    section: "Basic Settings"
    option: "Indexing-Enabled"
    value: "false"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [desktop, performance]

- name: Create fontconfig directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/fontconfig/conf.d"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, fonts]

- name: Configure font rendering for RDP
  ansible.builtin.copy:
    dest: "/home/{{ vps_username }}/.config/fontconfig/conf.d/10-rdp-rendering.conf"
    content: |
      <?xml version='1.0'?>
      <!DOCTYPE fontconfig SYSTEM 'fonts.dtd'>
      <fontconfig>
        <match target="font">
          <edit mode="assign" name="rgba"><const>none</const></edit>
          <edit mode="assign" name="hinting"><bool>true</bool></edit>
          <edit mode="assign" name="hintstyle"><const>hintfull</const></edit>
          <edit mode="assign" name="antialias"><bool>true</bool></edit>
        </match>
      </fontconfig>
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [desktop, fonts]

- name: Set animation duration to zero
  community.general.ini_file:
    path: "/home/{{ vps_username }}/.config/kdeglobals"
    section: "KDE"
    option: "AnimationDurationFactor"
    value: "0"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [desktop, performance]

- name: Create Akonadi config directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/akonadi"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [desktop, performance]

- name: Disable Akonadi server
  community.general.ini_file:
    path: "/home/{{ vps_username }}/.config/akonadi/akonadiserverrc"
    section: "General"
    option: "StartServer"
    value: "false"
    create: true
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [desktop, performance]

# =============================================================================
#  Service Management
# =============================================================================

- name: Enable SDDM display manager
  ansible.builtin.systemd:
    name: sddm
    enabled: true
    state: started
  tags: [desktop, sddm]

- name: Enable and start XRDP service
  ansible.builtin.systemd:
    name: xrdp
    enabled: true
    state: started
  when: vps_install_xrdp
  tags: [desktop, xrdp]

- name: Run desktop optimizations
  ansible.builtin.include_tasks: optimizations.yml
  tags: [desktop, optimization]

- name: Log desktop role completion
  ansible.builtin.debug:
    msg: "âœ“ Desktop role completed"
  tags: [desktop]
