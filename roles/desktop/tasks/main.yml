# Desktop Role - KDE Plasma + XRDP + Nordic Theme
# Full desktop environment for RDP access
---
- name: Desktop Role Tasks
  when: vps_install_desktop
  block:
    - name: Install desktop dependencies (Fish, Git, Python DBus)
      ansible.builtin.apt:
        name:
          - fish
          - git
          - python3-dbus
          - python-is-python3
          - xdg-user-dirs
          - qdbus-qt6
          # libkf6config-bin is not available on Ubuntu 24.04 (Noble), use libkf5config-bin
          - "{{ 'libkf5config-bin' if ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == '24' else 'libkf6config-bin' }}"
          - plasma-workspace
          - kde-config-gtk-style
          - xsettingsd
          # gtk3-engines-breeze removed in Debian 13, use breeze-gtk-theme
          - breeze-gtk-theme
          # gtk2-engines-breeze removed in Debian 13 and Ubuntu 24.04, replaced with breeze-gtk-theme
          - "{{ 'breeze-gtk-theme'
                if (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_major_version'] == '24')
                or (ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] == '13')
                else 'gtk2-engines-breeze' }}"
          - libglib2.0-dev-bin
          - pipewire-pulse
          - pipewire-module-xrdp

        state: present
      ignore_errors: "{{ ansible_check_mode }}"
      tags: [desktop, dependencies]

    - name: Ensure autostart directory exists
      ansible.builtin.file:
        path: "/home/{{ vps_username }}/.config/autostart"
        state: directory
        owner: "{{ vps_username }}"
        group: "{{ vps_username }}"
        mode: '0755'
      tags: [desktop, config]

    - name: Create Kvantum config directory
      ansible.builtin.file:
        path: '/home/{{ vps_username }}/.config/Kvantum'
        state: directory
        owner: '{{ vps_username }}'
        group: '{{ vps_username }}'
        mode: '0755'
        recurse: true
      tags: [desktop, theme]

    - name: Set Kvantum theme to WhiteSurDark
      community.general.ini_file:
        path: '/home/{{ vps_username }}/.config/Kvantum/kvantum.kvconfig'
        section: General
        option: theme
        value: WhiteSurDark
        create: true
        owner: '{{ vps_username }}'
        group: '{{ vps_username }}'
        mode: '0644'
      tags: [desktop, theme]

    - name: Create fontconfig directory
      ansible.builtin.file:
        path: "/home/{{ vps_username }}/.config/fontconfig/conf.d"
        state: directory
        owner: "{{ vps_username }}"
        group: "{{ vps_username }}"
        mode: '0755'
      tags: [desktop, fonts]

    - name: Configure font rendering for RDP
      ansible.builtin.copy:
        dest: "/home/{{ vps_username }}/.config/fontconfig/conf.d/10-rdp-rendering.conf"
        content: |
          <?xml version='1.0'?>
          <!DOCTYPE fontconfig SYSTEM 'fonts.dtd'>
          <fontconfig>
            <match target="font">
              <edit mode="assign" name="rgba"><const>none</const></edit>
              <edit mode="assign" name="hinting"><bool>true</bool></edit>
              <edit mode="assign" name="hintstyle"><const>hintfull</const></edit>
              <edit mode="assign" name="antialias"><bool>true</bool></edit>
            </match>
          </fontconfig>
        owner: "{{ vps_username }}"
        group: "{{ vps_username }}"
        mode: '0644'
      tags: [desktop, fonts]

    - name: Create Akonadi config directory
      ansible.builtin.file:
        path: "/home/{{ vps_username }}/.config/akonadi"
        state: directory
        owner: "{{ vps_username }}"
        group: "{{ vps_username }}"
        mode: '0755'
      tags: [desktop, performance]

    - name: Disable Akonadi server
      community.general.ini_file:
        path: "/home/{{ vps_username }}/.config/akonadi/akonadiserverrc"
        section: "General"
        option: "StartServer"
        value: "false"
        create: true
        owner: "{{ vps_username }}"
        group: "{{ vps_username }}"
        mode: '0644'
      tags: [desktop, performance]

    - name: Verify user exists before optimizations
      ansible.builtin.getent:
        database: passwd
        key: "{{ vps_username }}"
      register: user_check
      failed_when: false
      tags: [desktop, user_check]

    - name: Warn if user does not exist
      ansible.builtin.debug:
        msg: "WARNING: User '{{ vps_username }}' does not exist. Optimizations will be skipped. Please ensure 'common' role is run first to create the user."
      when: user_check.failed
      tags: [desktop, user_check]

    - name: Run desktop optimizations
      ansible.builtin.include_tasks: optimizations.yml
      when: not user_check.failed
      tags: [desktop, optimization]

    - name: Log desktop role completion
      ansible.builtin.debug:
        msg: "âœ“ Desktop role completed"
      tags: [desktop]

  rescue:
    - name: Log desktop role failure
      ansible.builtin.fail:
        msg: "CRITICAL FAILURE in Desktop Role: {{ ansible_failed_result.msg | default('Unknown error') }}"
      tags: [desktop]
