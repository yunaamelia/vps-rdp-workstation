# Development Role - Programming Languages
# Node.js, Python, PHP with all extensions
---
# =============================================================================
#  Node.js Installation (via NodeSource)
# =============================================================================

- name: Install Node.js prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Remove old NodeSource keyring if exists
  ansible.builtin.file:
    path: /usr/share/keyrings/nodesource.gpg
    state: absent
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Add NodeSource GPG key
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /usr/share/keyrings/nodesource.asc
    mode: '0644'
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nodesource.asc] https://deb.nodesource.com/node_20.x nodistro main"
    state: present
    filename: nodesource
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Configure npm global directory for user
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.npm-global"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Check npm prefix
  ansible.builtin.command: sudo -u {{ vps_username }} npm config get prefix
  register: npm_prefix_check
  changed_when: false
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Configure npm prefix
  ansible.builtin.command: |
    sudo -u {{ vps_username }} npm config set prefix "/home/{{ vps_username }}/.npm-global"
  changed_when: true
  when: vps_development_install_nodejs and npm_prefix_check.stdout != '/home/' + vps_username + '/.npm-global'
  tags: [development, nodejs]

- name: Check if npm package is installed
  ansible.builtin.command: "sudo -u {{ vps_username }} npm list -g {{ item }} --depth=0"
  loop: "{{ vps_development_npm_global_packages }}"
  register: npm_pkg_check
  changed_when: false
  failed_when: false
  when: vps_development_install_nodejs
  tags: [development, nodejs]

- name: Install global npm packages
  ansible.builtin.shell: |
    sudo -u {{ vps_username }} npm install -g {{ item.item }}
  loop: "{{ npm_pkg_check.results | default([]) }}"
  when: vps_development_install_nodejs and item.rc != 0
  become: true
  tags: [development, nodejs]

# =============================================================================
#  Python Installation
# =============================================================================

- name: Install Python and development packages
  ansible.builtin.apt:
    name:
      - build-essential
      - pkg-config
      - gfortran
      - libopenblas-dev
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - python3-numpy
      - python3-setuptools
      - python3-wheel
      - python3-apt
      - pipx
    state: present
  when: vps_development_install_python
  tags: [development, python]

- name: Check if pipx needs to modify PATH
  ansible.builtin.shell: |
    # Check for presence of .local/bin in PATH configuration
    sudo -u {{ vps_username }} grep -q "\.local/bin" /home/{{ vps_username }}/.bashrc || \
    ([ -f /home/{{ vps_username }}/.zshrc ] && sudo -u {{ vps_username }} grep -q "\.local/bin" /home/{{ vps_username }}/.zshrc)
  register: pipx_path_check
  changed_when: false
  failed_when: false
  when: vps_development_install_python
  tags: [development, python]

- name: Ensure pipx is in PATH for user
  ansible.builtin.command: |
    sudo -u {{ vps_username }} pipx ensurepath
  register: pipx_ensurepath_result
  changed_when: >
    'is already in PATH' not in (pipx_ensurepath_result.stdout | default(''))
    and 'is already in PATH' not in (pipx_ensurepath_result.stderr | default(''))
  when: vps_development_install_python and pipx_path_check.rc != 0
  tags: [development, python]

- name: Install Python tools via pipx
  ansible.builtin.shell: |
    sudo -u {{ vps_username }} pipx install {{ item }}
  args:
    creates: "/home/{{ vps_username }}/.local/bin/{{ item.split('[')[0] }}"
  loop: "{{ vps_development_python_pipx_packages }}"
  become: true
  when: vps_development_install_python
  tags: [development, python]

# =============================================================================
#  PHP Installation
# =============================================================================

- name: Install PHP and core packages
  ansible.builtin.apt:
    name:
      - php
      - php-cli
      - php-fpm
      - php-common
    state: present
  when: vps_development_install_php
  tags: [development, php]

- name: Install PHP extensions
  ansible.builtin.apt:
    name: "php-{{ item }}"
    state: present
  loop: "{{ vps_development_php_extensions }}"
  when: vps_development_install_php
  tags: [development, php]

- name: Download Composer installer
  ansible.builtin.get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-setup.php
    mode: '0644'
  when: vps_development_install_composer
  tags: [development, php]

- name: Verify Composer installer signature
  ansible.builtin.shell: |
    EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', '/tmp/composer-setup.php');")"
    if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
      echo 'ERROR: Invalid installer checksum'
      rm /tmp/composer-setup.php
      exit 1
    fi
  changed_when: false
  when: vps_development_install_composer
  tags: [development, php]

- name: Install Composer globally
  ansible.builtin.command: |
    php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
  args:
    creates: /usr/local/bin/composer
  when: vps_development_install_composer
  tags: [development, php]

- name: Remove Composer installer
  ansible.builtin.file:
    path: /tmp/composer-setup.php
    state: absent
  when: vps_development_install_composer
  tags: [development, php]

- name: Configure Git global email
  community.general.git_config:
    name: user.email
    scope: global
    value: "{{ vps_git_email }}"
  no_log: true
  become: true
  become_user: "{{ vps_username }}"
  when: vps_git_email is defined and vps_git_email | length > 0
  tags: [development, git]

- name: Log development role completion
  ansible.builtin.debug:
    msg: "âœ“ Development role completed - Node.js, Python, PHP installed"
  tags: [development]
