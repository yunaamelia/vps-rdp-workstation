---
- name: Install KDE power tools
  ansible.builtin.apt:
    name:
      - kde-config-gtk-style
      - kde-config-gtk-style-preview
      - kde-config-sddm
      - kinfocenter
      - partitionmanager
      - ksystemlog
    state: present
  when: vps_install_desktop | default(true)
  tags: [kde-opt, tools]

- name: Check if Baloo is disabled
  ansible.builtin.command: balooctl6 status
  register: baloo_status
  changed_when: false
  failed_when: false
  tags: [kde-opt, performance]

- name: Disable Baloo File Indexing
  ansible.builtin.command: balooctl6 disable
  when: "'Baloo is currently disabled' not in baloo_status.stdout"
  tags: [kde-opt, performance]

- name: Check if Polonium is installed
  ansible.builtin.stat:
    path: "/home/{{ vps_username }}/.local/share/kwin/scripts/polonium"
  register: polonium_dir
  when: vps_install_desktop | default(true)
  tags: [kde-opt, tiling]

- name: Download Polonium Source (Master)
  ansible.builtin.git:
    repo: "https://github.com/zeroxoneafour/polonium.git"
    dest: "/tmp/polonium-source"
    version: master
    depth: 1
    force: true
  when: (vps_install_desktop | default(true)) and (not polonium_dir.stat.exists)
  tags: [kde-opt, tiling]

- name: Install Polonium KWin Script (from source)
  ansible.builtin.command:
    cmd: "kpackagetool6 -t KWin/Script -i /tmp/polonium-source"
  become: true
  become_user: "{{ vps_username }}"
  when: (vps_install_desktop | default(true)) and (not polonium_dir.stat.exists)
  changed_when: true
  tags: [kde-opt, tiling]

- name: Cleanup Polonium Source
  ansible.builtin.file:
    path: "/tmp/polonium-source"
    state: absent
  when: (vps_install_desktop | default(true)) and (not polonium_dir.stat.exists)
  tags: [kde-opt, tiling]

- name: Deploy Captured KDE Configuration
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/home/{{ vps_username }}/.config/{{ item }}"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  loop:
    - kdeglobals
    - kwinrc
    - kglobalshortcutsrc
    - krunnerrc
    - kded5rc
    - kcminputrc
    - plasmashellrc
    - plasmarc
    - breezerc
    - baloofilerc
    - kscreenlockerrc
    - ksplashrc
    - klaunchrc
  notify: Reconfigure KWin
  tags: [kde-opt, config]

- name: Ensure GTK3 config directory exists
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/gtk-3.0"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [kde-opt, gtk]

- name: Deploy GTK3 Settings
  ansible.builtin.template:
    src: gtk3-settings.ini.j2
    dest: "/home/{{ vps_username }}/.config/gtk-3.0/settings.ini"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [kde-opt, gtk]

- name: Ensure GTK4 config directory exists
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/gtk-4.0"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [kde-opt, gtk]

- name: Deploy GTK4 Settings
  ansible.builtin.template:
    src: gtk4-settings.ini.j2
    dest: "/home/{{ vps_username }}/.config/gtk-4.0/settings.ini"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [kde-opt, gtk]

- name: Deploy GTK2 Settings
  ansible.builtin.template:
    src: gtkrc-2.0.j2
    dest: "/home/{{ vps_username }}/.gtkrc-2.0"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [kde-opt, gtk]

- name: Ensure xsettingsd config directory exists
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/xsettingsd"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [kde-opt, gtk]

- name: Deploy xsettingsd configuration
  ansible.builtin.template:
    src: xsettingsd.conf.j2
    dest: "/home/{{ vps_username }}/.config/xsettingsd/xsettingsd.conf"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  notify: Restart xsettingsd
  tags: [kde-opt, gtk]

- name: Trigger GTK Config Reload (DBus)
  ansible.builtin.command:
    cmd: "su - {{ vps_username }} -c 'qdbus6 org.kde.kded6 /kded org.kde.kded6.loadModule gtkconfig || true'"
  when: vps_install_desktop | default(true)
  changed_when: false
  failed_when: false
  tags: [kde-opt, gtk, trigger]

- name: Ensure Mozilla config directory exists (for system-wide)
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.mozilla"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [kde-opt, firefox]

- name: Ensure Firefox profiles directory exists
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.mozilla/firefox"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [kde-opt, firefox]

- name: Find Firefox profiles
  ansible.builtin.find:
    paths: "/home/{{ vps_username }}/.mozilla/firefox"
    patterns: "*.default*"
    file_type: directory
  register: vps_kde_firefox_profiles
  failed_when: false
  when: vps_install_desktop | default(true)
  tags: [kde-opt, firefox]

- name: Deploy Firefox dark mode preferences
  ansible.builtin.template:
    src: firefox-user.js.j2
    dest: "{{ item.path }}/user.js"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  loop: "{{ vps_kde_firefox_profiles.files | default([]) }}"
  when: (vps_kde_firefox_profiles.matched | default(0) > 0) and (vps_install_desktop | default(true))
  tags: [kde-opt, firefox]

- name: Configure Dolphin (General)
  community.general.ini_file:
    path: "/home/{{ vps_username }}/.config/dolphinrc"
    section: "General"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    create: true
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  loop:
    - { option: "ShowFullPath", value: "true" }
    - { option: "FilterBar", value: "true" }
  tags: [kde-opt, ux]

- name: Create panel configuration script
  ansible.builtin.copy:
    dest: "/home/{{ vps_username }}/.local/bin/configure-panel.sh"
    mode: '0755'
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    content: |
      #!/bin/bash
      # Wait for Plasma to be ready
      until qdbus6 org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'print("ready")' &>/dev/null; do
          sleep 2
      done

      # Run the config script
      qdbus6 org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript '
      var p = panels();
      for (var i = 0; i < p.length; i++) {
          if (p[i].location == "bottom") {
              p[i].height = 52;
              p[i].alignment = "center";
              p[i].floating = true;
              p[i].lengthMode = "fit";
          }
      }'

      # Remove self from autostart to run only once
      rm -f "$HOME/.config/autostart/configure-panel.desktop"
  tags: [kde-opt, panel]

- name: Create autostart entry for panel configuration
  ansible.builtin.copy:
    dest: "/home/{{ vps_username }}/.config/autostart/configure-panel.desktop"
    mode: '0644'
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    content: |
      [Desktop Entry]
      Type=Application
      Name=Configure Panel
      Exec=/home/{{ vps_username }}/.local/bin/configure-panel.sh
      X-KDE-autostart-phase=2
  tags: [kde-opt, panel]

- name: Enable Autostart Applications
  ansible.builtin.file:
    src: "/usr/share/applications/{{ item }}"
    dest: "/home/{{ vps_username }}/.config/autostart/{{ item }}"
    state: link
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
  loop: "{{ vps_kde_autostart_apps | default([]) }}"
  when: vps_kde_autostart_apps | default([]) | length > 0
  tags: [kde-opt, autostart]
