---
- name: Install Klassy build dependencies
  ansible.builtin.apt:
    name: "{{ vps_klassy_build_deps }}"
    state: present
  tags: [klassy, dependencies]

- name: Check if Klassy is already installed
  ansible.builtin.stat:
    path: /usr/lib/x86_64-linux-gnu/qt6/plugins/org.kde.kdecoration3/org.kde.klassy.so
  register: klassy_installed
  tags: [klassy, install]

- name: Clone Klassy repository
  ansible.builtin.git:
    repo: "{{ vps_klassy_repo }}"
    dest: /tmp/klassy
    version: "{{ vps_klassy_branch }}"
    force: true
  when: not klassy_installed.stat.exists
  tags: [klassy, download]

- name: Build and install Klassy
  ansible.builtin.shell: |
    cd /tmp/klassy
    ./install.sh
  args:
    chdir: /tmp/klassy
  when: not klassy_installed.stat.exists
  register: klassy_build
  changed_when: "'Installed successfully' in klassy_build.stdout"
  tags: [klassy, install]

- name: Create Klassy config directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/klassy"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [klassy, config]

- name: Deploy Klassy configuration
  ansible.builtin.template:
    src: klassyrc.j2
    dest: "/home/{{ vps_username }}/.config/klassy/klassyrc"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  notify: Reconfigure KWin
  tags: [klassy, config]

- name: Cleanup Klassy build directory
  ansible.builtin.file:
    path: /tmp/klassy
    state: absent
  tags: [klassy, cleanup]
