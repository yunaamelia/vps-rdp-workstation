# Shell Styling Role
# Implements Fastfetch and deploys optimized .zshrc template
---
- name: Install Fastfetch (modern neofetch alternative)
  ansible.builtin.get_url:
    url: >-
      https://github.com/fastfetch-cli/fastfetch/releases/latest/download/fastfetch-linux-amd64.deb
    dest: /tmp/fastfetch.deb
    mode: '0644'
  register: fastfetch_download
  until: fastfetch_download is success
  retries: 3
  tags: [shell, visual, fastfetch]

- name: Install Fastfetch package
  ansible.builtin.apt:
    deb: /tmp/fastfetch.deb
    state: present
  become: true
  when: fastfetch_download is success and not ansible_check_mode
  tags: [shell, visual, fastfetch]

- name: Create fastfetch config directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.config/fastfetch"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [shell, visual, fastfetch]

- name: Generate default fastfetch config
  ansible.builtin.shell: |
    sudo -u {{ vps_username }} fastfetch --gen-config
  args:
    creates: "/home/{{ vps_username }}/.config/fastfetch/config.jsonc"
  become: true
  tags: [shell, visual, fastfetch]

- name: Check if Starship is installed
  ansible.builtin.stat:
    path: /usr/local/bin/starship
  register: starship_bin
  tags: [shell, visual, starship]

- name: Download Starship install script
  ansible.builtin.get_url:
    url: https://starship.rs/install.sh
    dest: /tmp/starship_install.sh
    mode: '0755'
  tags: [shell, visual, starship]
  when:
    - vps_install_starship | default(true)
    - not starship_bin.stat.exists

- name: Install Starship
  ansible.builtin.command: sh /tmp/starship_install.sh -y -b /usr/local/bin
  args:
    creates: /usr/local/bin/starship
  become: true
  tags: [shell, visual, starship]
  when: vps_install_starship | default(true)

- name: Deploy Starship configuration
  ansible.builtin.template:
    src: starship.toml.j2
    dest: "/home/{{ vps_username }}/.config/starship.toml"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [shell, visual, starship]
  when: vps_install_starship | default(true)

- name: Deploy optimized zshrc configuration
  ansible.builtin.template:
    src: zshrc.j2
    dest: "/home/{{ vps_username }}/.zshrc"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0644'
  tags: [shell, zsh]

- name: Log shell-styling role completion
  ansible.builtin.debug:
    msg: "âœ“ Shell Styling role completed"
  tags: [shell, visual]
