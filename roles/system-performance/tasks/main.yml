# System Performance Role
---
- name: Install performance monitoring tools
  ansible.builtin.apt:
    name:
      - htop
      - dstat
      - sysstat
      - iotop
      - inxi
      - lsof
      - strace
      - psmisc
    state: present
  tags: [tools, performance]

- name: Install btop from repository
  ansible.builtin.apt:
    name: btop
    state: present
  ignore_errors: true
  tags: [tools, performance]

- name: Install ncdu for disk usage
  ansible.builtin.apt:
    name: ncdu
    state: present
  tags: [tools, performance]

- name: Install zram-tools for memory optimization
  ansible.builtin.apt:
    name: zram-tools
    state: present
  tags: [tools, performance]

- name: Configure zram-tools
  ansible.builtin.lineinfile:
    path: /etc/default/zramswap
    regexp: '^ALGO='
    line: 'ALGO=zstd'
    create: true
  tags: [tools, performance]

- name: Enable BBR congestion control
  ansible.posix.sysctl:
    name: net.ipv4.tcp_congestion_control
    value: bbr
    state: present
    reload: true
  ignore_errors: true
  tags: [tools, performance]

- name: Install duf (du alternative)
  ansible.builtin.shell: |
    DUF_VERSION=$(curl -s https://api.github.com/repos/muesli/duf/releases/latest | grep -oP '"tag_name": "v\K[^"]+')
    curl -LO https://github.com/muesli/duf/releases/download/v${DUF_VERSION}/duf_${DUF_VERSION}_linux_amd64.deb
    dpkg -i duf_${DUF_VERSION}_linux_amd64.deb
  args:
    chdir: /tmp
    creates: /usr/bin/duf
  changed_when: false
  ignore_errors: true
  tags: [tools, performance]

- name: Log system-performance role completion
  ansible.builtin.debug:
    msg: "âœ“ System Performance role completed"
  tags: [tools, performance]
