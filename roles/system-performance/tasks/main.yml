# System Performance Role
---
- name: Install performance monitoring tools
  ansible.builtin.apt:
    name:
      - htop
      - dstat
      - sysstat
      - iotop
      - inxi
      - lsof
      - strace
      - psmisc
    state: present
  tags: [tools, performance]

- name: Install btop from repository
  ansible.builtin.apt:
    name: btop
    state: present
  tags: [tools, performance]

- name: Install ncdu for disk usage
  ansible.builtin.apt:
    name: ncdu
    state: present
  tags: [tools, performance]

- name: Install zram-tools for memory optimization
  ansible.builtin.apt:
    name: zram-tools
    state: present
  tags: [tools, performance]

- name: Configure zram-tools
  ansible.builtin.lineinfile:
    path: /etc/default/zramswap
    regexp: '^ALGO='
    line: 'ALGO=zstd'
    create: true
    mode: '0644'
  tags: [tools, performance]

- name: Enable BBR congestion control
  ansible.posix.sysctl:
    name: net.ipv4.tcp_congestion_control
    value: bbr
    state: present
    sysctl_file: /etc/sysctl.d/99-workstation.conf
    reload: true
  failed_when:
    - result.failed
    - ansible_virtualization_type != 'docker'
  register: result
  tags: [tools, performance]

- name: Optimize VFS cache pressure
  ansible.posix.sysctl:
    name: vm.vfs_cache_pressure
    value: '50'
    state: present
    sysctl_file: /etc/sysctl.d/99-workstation.conf
    reload: true
  tags: [performance, sysctl]

- name: Optimize dirty ratio
  ansible.posix.sysctl:
    name: vm.dirty_ratio
    value: '10'
    state: present
    sysctl_file: /etc/sysctl.d/99-workstation.conf
    reload: true
  tags: [performance, sysctl]

- name: Optimize dirty background ratio
  ansible.posix.sysctl:
    name: vm.dirty_background_ratio
    value: '5'
    state: present
    sysctl_file: /etc/sysctl.d/99-workstation.conf
    reload: true
  tags: [performance, sysctl]

- name: Configure I/O schedulers via udev
  ansible.builtin.copy:
    dest: /etc/udev/rules.d/60-io-scheduler.rules
    content: |
      # NVMe SSDs - use 'none' scheduler (let device handle it)
      ACTION=="add|change", KERNEL=="nvme[0-9]n[0-9]", ATTR{queue/scheduler}="none"

      # SATA SSDs (non-rotational) - use 'mq-deadline'
      ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="0", ATTR{queue/scheduler}="mq-deadline"

      # Rotating HDDs - use 'bfq' for desktop responsiveness
      ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", ATTR{queue/scheduler}="bfq"
    mode: '0644'
  notify: Reload udev rules
  tags: [performance, udev]

- name: Install systemd-oomd
  ansible.builtin.apt:
    name: systemd-oomd
    state: present
  tags: [performance, oomd]

- name: Enable systemd-oomd service
  ansible.builtin.service:
    name: systemd-oomd
    state: started
    enabled: true
  tags: [performance, oomd]

- name: Install duf (du alternative)
  ansible.builtin.shell: |
    set -o pipefail
    DUF_VERSION=$(curl -s https://api.github.com/repos/muesli/duf/releases/latest | grep -oP '"tag_name": "v\K[^"]+')
    curl -LO https://github.com/muesli/duf/releases/download/v${DUF_VERSION}/duf_${DUF_VERSION}_linux_amd64.deb
    dpkg -i duf_${DUF_VERSION}_linux_amd64.deb
  args:
    chdir: /tmp
    creates: /usr/bin/duf
    executable: /bin/bash
  tags: [tools, performance]

- name: Log system-performance role completion
  ansible.builtin.debug:
    msg: "âœ“ System Performance role completed"
  tags: [tools, performance]
