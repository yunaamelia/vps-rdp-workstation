# TUI Tools Role - Terminal User Interface Tools
# Version: 4.0.0
---
- name: Install TUI tools from apt
  ansible.builtin.apt:
    name:
      - tig
      - ranger
      - mc
      - vifm
      - fzf
      - eza
      # Modern CLI tools
      - git-delta
      - duf
      - bat
      - fd-find
      - ripgrep
      # System monitors
      - btop
      - htop
      - ncdu
      # CLI productivity
      - hyperfine
      - tokei
      - thefuck
      # Yazi dependencies
      - 7zip
      - poppler-utils
      - imagemagick
      - ffmpeg
      - jq
    state: present
  tags: [tools, tui]

- name: Create bat symlink (batcat -> bat)
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: /usr/local/bin/bat
    state: link
    force: true
  tags: [tools, tui]

- name: Create fd symlink (fdfind -> fd)
  ansible.builtin.file:
    src: /usr/bin/fdfind
    dest: /usr/local/bin/fd
    state: link
    force: true
  tags: [tools, tui]

- name: Download lazygit (versioned with checksum)
  ansible.builtin.get_url:
    url: >-
      https://github.com/jesseduffield/lazygit/releases/download/v{{ vps_tui_tools_lazygit_version }}/lazygit_{{ vps_tui_tools_lazygit_version }}_Linux_x86_64.tar.gz
    dest: /tmp/lazygit.tar.gz
    mode: '0644'
  register: lazygit_download
  ignore_errors: true
  tags: [tools, tui]

- name: Get lazygit latest release as fallback (if versioned failed)
  ansible.builtin.uri:
    url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
    return_content: true
  register: lazygit_release
  when: lazygit_download is failed
  ignore_errors: true
  tags: [tools, tui]

- name: Download lazygit latest as fallback
  ansible.builtin.get_url:
    url: >-
      https://github.com/jesseduffield/lazygit/releases/download/{{ lazygit_release.json.tag_name }}/
      lazygit_{{ lazygit_release.json.tag_name | regex_replace('v', '') }}_Linux_x86_64.tar.gz
    dest: /tmp/lazygit.tar.gz
    mode: '0644'
  when:
    - lazygit_download is failed
    - lazygit_release is success
    - lazygit_release.json is defined
  tags: [tools, tui]

- name: Extract lazygit
  ansible.builtin.unarchive:
    src: /tmp/lazygit.tar.gz
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/lazygit
  when: (lazygit_download is success) or (lazygit_release is defined and lazygit_release is success)
  tags: [tools, tui]

- name: Verify lazygit installation
  ansible.builtin.command: lazygit --version
  register: vps_tui_tools_lazygit_version_check
  changed_when: false
  failed_when: false
  tags: [tools, tui]

- name: Clean up lazygit archive
  ansible.builtin.file:
    path: /tmp/lazygit.tar.gz
    state: absent
  tags: [tools, tui]

- name: Get yazi latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/sxyazi/yazi/releases/latest
    return_content: true
  register: yazi_release
  check_mode: false
  ignore_errors: true
  tags: [tools, tui, yazi]

- name: Download and install yazi .deb
  ansible.builtin.apt:
    deb: "https://github.com/sxyazi/yazi/releases/download/{{ yazi_release.json.tag_name }}/yazi-x86_64-unknown-linux-gnu.deb"
  when:
    - yazi_release is success
    - yazi_release.json is defined
  tags: [tools, tui, yazi]

# ==============================================================================
# Glow - Terminal Markdown Renderer
# ==============================================================================

- name: Get glow latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/charmbracelet/glow/releases/latest
    return_content: true
  register: glow_release
  check_mode: false
  ignore_errors: true
  tags: [tools, tui, glow]

- name: Download and install glow .deb
  ansible.builtin.apt:
    deb: >-
      https://github.com/charmbracelet/glow/releases/download/{{ glow_release.json.tag_name }}/glow_{{ glow_release.json.tag_name | regex_replace('v', '') }}_amd64.deb
  when:
    - glow_release is success
    - glow_release.json is defined
  tags: [tools, tui, glow]

# ==============================================================================
# Navi - Interactive Cheatsheet Tool
# ==============================================================================

- name: Check if navi is installed
  ansible.builtin.stat:
    path: /usr/local/bin/navi
  register: navi_bin
  tags: [tools, tui, navi]

- name: Get navi latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/denisidoro/navi/releases/latest
    return_content: true
  register: navi_release
  check_mode: false
  ignore_errors: true
  when: not navi_bin.stat.exists
  tags: [tools, tui, navi]

- name: Download navi
  ansible.builtin.get_url:
    url: >-
      https://github.com/denisidoro/navi/releases/download/{{ navi_release.json.tag_name }}/navi-{{ navi_release.json.tag_name }}-x86_64-unknown-linux-musl.tar.gz
    dest: /tmp/navi.tar.gz
    mode: '0644'
  when:
    - not navi_bin.stat.exists
    - navi_release is success
    - navi_release.json is defined
  tags: [tools, tui, navi]

- name: Extract navi
  ansible.builtin.unarchive:
    src: /tmp/navi.tar.gz
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/navi
  when:
    - not navi_bin.stat.exists
    - navi_release is defined
    - navi_release is success
  tags: [tools, tui, navi]

- name: Clean up navi archive
  ansible.builtin.file:
    path: /tmp/navi.tar.gz
    state: absent
  tags: [tools, tui, navi]

# ==============================================================================
# Atuin - Magical Shell History
# ==============================================================================

- name: Check if atuin is installed
  ansible.builtin.stat:
    path: /usr/bin/atuin
  register: atuin_bin
  tags: [tools, tui, atuin]

- name: Get atuin latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/atuinsh/atuin/releases/latest
    return_content: true
  register: atuin_release
  check_mode: false
  ignore_errors: true
  when: not atuin_bin.stat.exists
  tags: [tools, tui, atuin]

- name: Download Atuin tarball
  ansible.builtin.get_url:
    url: >-
      https://github.com/atuinsh/atuin/releases/download/{{ atuin_release.json.tag_name }}/atuin-x86_64-unknown-linux-gnu.tar.gz
    dest: /tmp/atuin.tar.gz
    mode: '0644'
  when:
    - not atuin_bin.stat.exists
    - atuin_release is success
    - atuin_release.json is defined
  tags: [tools, tui, atuin]

- name: Extract Atuin
  ansible.builtin.unarchive:
    src: /tmp/atuin.tar.gz
    dest: /tmp
    remote_src: true
  when:
    - not atuin_bin.stat.exists
    - atuin_release is success
  tags: [tools, tui, atuin]

- name: Install Atuin binary
  ansible.builtin.copy:
    src: /tmp/atuin-x86_64-unknown-linux-gnu/atuin
    dest: /usr/local/bin/atuin
    mode: '0755'
    remote_src: true
  when:
    - not atuin_bin.stat.exists
    - atuin_release is success
  tags: [tools, tui, atuin]

- name: Cleanup Atuin artifacts
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/atuin.tar.gz
    - /tmp/atuin-x86_64-unknown-linux-gnu
  tags: [tools, tui, atuin]

# ==============================================================================
# Tealdeer (tldr) - Simplified Man Pages
# ==============================================================================

- name: Check if tldr is installed
  ansible.builtin.stat:
    path: /usr/local/bin/tldr
  register: tldr_bin
  tags: [tools, tui, tldr]

- name: Get tealdeer latest release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/tealdeer-rs/tealdeer/releases/latest
    return_content: true
  register: tldr_release
  check_mode: false
  ignore_errors: true
  when: not tldr_bin.stat.exists
  tags: [tools, tui, tldr]

- name: Download tealdeer binary
  ansible.builtin.get_url:
    url: >-
      https://github.com/tealdeer-rs/tealdeer/releases/download/{{ tldr_release.json.tag_name }}/tealdeer-linux-x86_64-musl
    dest: /usr/local/bin/tldr
    mode: '0755'
  when:
    - not tldr_bin.stat.exists
    - tldr_release is success
    - tldr_release.json is defined
  tags: [tools, tui, tldr]

- name: Log tui-tools role completion
  ansible.builtin.debug:
    msg: "âœ“ TUI Tools role completed - all CLI tools installed"
  tags: [tools, tui]
