#!/bin/sh
# XRDP Startup Script for Debian 13 (Trixie) with KDE Plasma 6
# Managed by Ansible

if test -r /etc/profile; then
    . /etc/profile
fi

if test -r ~/.profile; then
    . ~/.profile
fi

# Set crucial environment variables for Plasma 6
export XDG_SESSION_TYPE=x11
export XDG_CURRENT_DESKTOP=KDE
export XDG_CONFIG_DIRS=/etc/xdg
export DESKTOP_SESSION=plasma
export QT_QPA_PLATFORM=xcb

# Fix: Prevent KDE Plasma 6 black screen by ensuring DBus session
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax --exit-with-session)
fi

# Start GNOME Keyring daemon to prevent PAM warnings during XRDP sessions
if command -v gnome-keyring-daemon >/dev/null 2>&1; then
    eval $(gnome-keyring-daemon --start --components=secrets,ssh,pkcs11 2>/dev/null)
    export GNOME_KEYRING_CONTROL GNOME_KEYRING_PID SSH_AUTH_SOCK
fi

# Launch KDE Plasma 6 (Force X11 backend for XRDP compatibility)
exec /usr/bin/startplasma-x11
