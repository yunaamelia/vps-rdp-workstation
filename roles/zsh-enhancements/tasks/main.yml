# Zsh Enhancements Role - External Plugins
# Advanced Zsh plugins and zoxide
---
- name: Create custom plugins directory
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.oh-my-zsh/custom/plugins"
    state: directory
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    mode: '0755'
  tags: [zsh-plugins]

- name: Add safe.directory for external Zsh plugins
  community.general.git_config:
    name: safe.directory
    scope: global
    value: "/home/{{ vps_username }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
    add_mode: add
  loop: "{{ vps_omz_external_plugins }}"
  tags: [zsh-plugins]

- name: Clone external Zsh plugins
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "/home/{{ vps_username }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
    depth: 1
    version: "{{ item.version | default('HEAD') }}"
    update: true
  become: true
  loop: "{{ vps_omz_external_plugins }}"
  tags: [zsh-plugins]

- name: Fix external Zsh plugins ownership
  ansible.builtin.file:
    path: "/home/{{ vps_username }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
    owner: "{{ vps_username }}"
    group: "{{ vps_username }}"
    recurse: true
  become: true
  loop: "{{ vps_omz_external_plugins }}"
  tags: [zsh-plugins]

- name: Install fzf for fuzzy finding
  ansible.builtin.apt:
    name: fzf
    state: present
  tags: [zsh-plugins]

- name: Install zoxide for smart directory jumping
  ansible.builtin.shell: |
    set -o pipefail
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
  args:
    creates: /usr/local/bin/zoxide
    executable: /bin/bash
  when: vps_install_zoxide
  tags: [zsh-plugins]

- name: Move zoxide to accessible location
  ansible.builtin.shell: |
    mv ~/.local/bin/zoxide /usr/local/bin/zoxide 2>/dev/null || true
  changed_when: false
  when: vps_install_zoxide
  tags: [zsh-plugins]

- name: Log zsh-enhancements role completion
  ansible.builtin.debug:
    msg: "âœ“ Zsh Enhancements role completed - External plugins and zoxide installed"
  tags: [zsh-plugins]
